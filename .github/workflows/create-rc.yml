name: Create Release Candidate

# Create a release candidate that will then build the artifacts

on:
  push:
    branches:
      - master
    paths-ignore:
      # Do not run this workflow if the only changes are in the .github directory
      # this should avoid duplicating releases for changes that don't actually belong
      # in releases (CI changes are not shipped with the binaries).
      # If you want to run it anyway, do so manually.
      # See the following link for more information:
      # - https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#example-excluding-paths
      - ".github/**"
  workflow_dispatch:

jobs:
  create-release-candidate:
    runs-on: [self-hosted, Linux]

    # We double check here since we can use workflow_dispatch to run it against any branch
    if: ${{ github.ref == 'refs/heads/master' }}

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Create a release candidate
        # id required to access the output
        id: create-rc
        run: cargo run --release -- release
        working-directory: rust/release
        # If everything works, it creates a RELEASE_BRANCH output
      - name: Create a PR
        if: ${{steps.create-rc.outputs.RELEASE_BRANCH != ''}}
        # Requires the `gh` tool (duh!)
        # https://github.com/cli/cli/blob/trunk/docs/install_linux.md
        # Explanation - create a PR from master to RELEASE_BRANCH with the provided title
        # Relevant code in gh pr create:
        # - https://github.com/cli/cli/blob/343896fdac9ee1aeee7152f66765832c31cc87f6/pkg/cmd/pr/create/create.go#L284-L290
        # - https://github.com/cli/cli/blob/343896fdac9ee1aeee7152f66765832c31cc87f6/pkg/cmd/pr/create/create.go#L395-L423
        run: gh pr create --base master --head ${{steps.create-rc.outputs.RELEASE_BRANCH}} --fill
        # The GitHub CLI reads this value to login automatically
        # https://cli.github.com/manual/gh_auth_login
        env:
          GH_TOKEN: ${{ secrets.GENIE_GH_TOKEN }}

  notify-discord:
    runs-on: [self-hosted, Linux]
    if: ${{ always() }}

    needs:
      - create-release-candidate

    steps:
      - uses: jmg-duarte/discord-workflow-status@5a826a3e649f9d1157507494d35811ec2f84380c
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          discord-webhook: ${{ secrets.DISCORD_WEBHOOK }}
